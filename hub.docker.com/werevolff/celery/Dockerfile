FROM werevolff/pyenv

ARG CELERY_VERSION='4.2.0'
ENV CELERY_VERSION=$CELERY_VERSION

ARG SUPERVISORD_VERSION='4.0.4'
ENV SUPERVISORD_VERSION=$SUPERVISORD_VERSION

ARG RABBITMQ_DEFAULT_USER='rabbit_mq_user'
ENV RABBITMQ_DEFAULT_USER=$RABBITMQ_DEFAULT_USER

ARG RABBITMQ_DEFAULT_PASS='rabbit_mq_password'
ENV RABBITMQ_DEFAULT_PASS=$RABBITMQ_DEFAULT_PASS

ARG RABBITMQ_HOST='rabbit_mq_host'
ENV RABBITMQ_HOST=$RABBITMQ_HOST

ARG RABBITMQ_PORT='5672'
ENV RABBITMQ_PORT=$RABBITMQ_PORT

ARG RABBITMQ_DEFAULT_VHOST='rabbit_mq_vhost'
ENV RABBITMQ_DEFAULT_VHOST=$RABBITMQ_DEFAULT_VHOST

ARG CELERY_BROKER_URL=amqp://$RABBITMQ_DEFAULT_USER:$RABBITMQ_DEFAULT_PASS@$RABBITMQ_HOST:$RABBITMQ_PORT//$RABBITMQ_DEFAULT_VHOST
ENV CELERY_BROKER_URL=$CELERY_BROKER_URL

ARG CELERYD_NODES='w1 w2 w3'
ENV CELERYD_NODES=$CELERYD_NODES

ARG CELERY_APP='app'
ENV CELERY_APP=$CELERY_APP

ARG PROJECT_USER='celery'
ENV PROJECT_USER=$PROJECT_USER

ARG CELERY_WORKDIR=/home/$PROJECT_USER
ENV CELERY_WORKDIR=$CELERY_WORKDIR

ARG CELERY_HOMEDIR=/home/$PROJECT_USER
ENV CELERY_HOMEDIR=$CELERY_HOMEDIR

ARG CELERYD_PID_DIR=$CELERY_HOMEDIR/pid
ENV CELERYD_PID_DIR=$CELERYD_PID_DIR

ARG CELERYD_PID_FILE=$CELERYD_PID_DIR/celeryd_%n.pid
ENV CELERYD_PID_FILE=$CELERYD_PID_FILE

ARG CELERYD_BEAT_PID_FILE=$CELERYD_PID_DIR/beat_%n.pid
ENV CELERYD_BEAT_PID_FILE=$CELERYD_BEAT_PID_FILE

ARG CELERYD_LOG_DIR=$CELERY_HOMEDIR/logs
ENV CELERYD_LOG_DIR=$CELERYD_LOG_DIR

ARG CELERYD_LOG_FILE=$CELERYD_LOG_DIR/celeryd_%n%I.log
ENV CELERYD_LOG_FILE=$CELERYD_LOG_FILE

ARG CELERYD_BEAT_LOG_FILE=$CELERYD_LOG_DIR/beat_%n%I.log
ENV CELERYD_BEAT_LOG_FILE=$CELERYD_BEAT_LOG_FILE

ARG CELERYD_SUPERVISORD_LOG_FILE=$CELERYD_LOG_DIR/supervisord.log
ENV CELERYD_SUPERVISORD_LOG_FILE=$CELERYD_SUPERVISORD_LOG_FILE

ARG CELERYD_LOG_LEVEL='WARNING'
ENV CELERYD_LOG_LEVEL=$CELERYD_LOG_LEVEL

ARG CELERYD_SUPERVISORD_LOG_LEVEL='warn'
ENV CELERYD_SUPERVISORD_LOG_LEVEL=$CELERYD_SUPERVISORD_LOG_LEVEL

ARG CELERYD_OPTS='--time-limit=300 --concurrency=8'
ENV CELERYD_OPTS=$CELERYD_OPTS

# Set up log rotation
COPY logrotate.d /etc/logrotate.d

# Set up supervisord config
COPY supervisord.conf $CELERY_HOMEDIR/supervisord.conf

# Create celery user
RUN groupadd $PROJECT_USER && useradd --create-home --home-dir $CELERY_HOMEDIR -g $PROJECT_USER $PROJECT_USER

# Install Celery
RUN pip install Celery==$CELERY_VERSION
# Install Supervisor
RUN pip install supervisor==$SUPERVISORD_VERSION

# Create config
WORKDIR $CELERY_HOMEDIR
RUN { \
	echo 'import os'; \
	echo "BROKER_URL = os.environ.get('CELERY_BROKER_URL', 'amqp://')"; \
} > celeryconfig.py
RUN { \
	echo 'from __future__ import absolute_import, unicode_literals'; \
	echo 'import os'; \
	echo 'from celery import Celery'; \
	echo "app = Celery('$CELERY_APP')"; \
} > app.py

# Create directories
RUN mkdir -p $CELERYD_PID_DIR
RUN mkdir -p $CELERYD_LOG_DIR
RUN chown -hR $PROJECT_USER $CELERYD_PID_DIR
RUN chown -hR $PROJECT_USER $CELERYD_LOG_DIR

# User
WORKDIR $CELERY_WORKDIR

# Run supervisord
CMD supervisord -c $CELERY_HOMEDIR/supervisord.conf -u $PROJECT_USER
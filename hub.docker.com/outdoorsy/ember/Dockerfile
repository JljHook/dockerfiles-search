# Start from the CircleCI autogenerated baseline as it comes with fixes, docker,
# and a lot of things we'd just have to repeat.
ARG NODE_VERSION=10.15.3
FROM circleci/node:$NODE_VERSION
USER root

# ember server on port 4200
# livereload server on port 7020 (changed in v2.17.0 from 49153)
# test server on port 7357
EXPOSE 4200 7020 7357
WORKDIR /repo

# Remove dpkg warnings by installing apt-utils, then install yarn:$YARN_VERSION
RUN apt-get update && apt-get install -y apt-utils apt-transport-https
RUN curl -sS https://dl.yarnpkg.com/debian/pubkey.gpg | apt-key add -
RUN echo "deb https://dl.yarnpkg.com/debian/ stable main" | tee /etc/apt/sources.list.d/yarn.list
RUN apt-get update && apt-get install yarn

RUN groupadd --gid 1337 ember \
  && useradd --uid 1337 --gid ember --shell /bin/bash --create-home ember \
  && echo 'ember ALL=NOPASSWD: ALL' >> /etc/sudoers.d/50-ember \
  && echo 'Defaults    env_keep += "DEBIAN_FRONTEND"' >> /etc/sudoers.d/env_keep \
  && chown ember: /repo

USER ember

# Install Chrome for default testem config
RUN curl --silent --show-error --location --fail --retry 3 --output /tmp/google-chrome-stable_current_amd64.deb https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb \
    && (sudo dpkg -i /tmp/google-chrome-stable_current_amd64.deb || sudo apt-get -fy install)  \
    && rm -rf /tmp/google-chrome-stable_current_amd64.deb \
    && sudo sed -i 's|HERE/chrome"|HERE/chrome" --disable-setuid-sandbox --no-sandbox|g' \
        "/opt/google/chrome/google-chrome" \
    && google-chrome --version

# start xvfb automatically to avoid needing to express in circle.yml
ENV DISPLAY :99
RUN printf '#!/bin/sh\nXvfb :99 -screen 0 1280x1024x24 &\nexec "$@"\n' > /tmp/entrypoint \
  && chmod +x /tmp/entrypoint \
        && sudo mv /tmp/entrypoint /docker-entrypoint.sh

# Explicit versions for the dependenies
ARG EMBER_VERSION=3.9.0
ARG BOWER_VERSION=1.8.8
ARG YARN_VERSION=1.15.0

RUN curl --compressed -o- -L https://yarnpkg.com/install.sh | bash -s -- --version ${YARN_VERSION}
RUN yarn global add ember-cli@$EMBER_VERSION bower@$BOWER_VERSION

CMD ["ember", "serve"]
